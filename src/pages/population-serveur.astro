---
import Layout from "../layouts/Layout.astro";
import PlotFigure from "../components/PlotFigure.astro";
import * as Plot from "@observablehq/plot";
import population from "../assets/population.json";

// Année la plus récente
const annees = [...new Set(population.map(d => d["Période"]))].sort((a,b)=>b-a);
const annee  = annees[0];

// Totaux par département
const toNumber = v => Number(String(v).replace(/\s/g, "").replace(",", "."));
const rowsAll = population
  .filter(d => d["Période"] === annee && d["Sexe"] === "Total" && d["Âge"] === "Total")
  .map(d => ({ dep: d["Géographie"], val: toNumber(d["Valeur"]) || 0 }));

const TOP = 25;
const rows = rowsAll.sort((a,b)=>b.val - a.val).slice(0, TOP);

const options = {
  title: `Population — année ${annee} (Top ${TOP})`,
  subtitle: "Totaux par département (tri décroissant)",
  ariaLabel: "Bar chart des populations par département",
  height: 520,
  marginLeft: 100,
  marginBottom: 90,
  x: { label: "Département", tickRotate: -45 },
  y: { label: "Population", grid: true, tickFormat: d => d.toLocaleString("fr-FR") },
  marks: [
    Plot.barY(rows, { x: "dep", y: "val", tip: true, inset: 0.5 }),
    Plot.ruleY([0])
  ]
};
---
<Layout title="TP7 — Population (serveur)">
  <PlotFigure {options} />
</Layout>
