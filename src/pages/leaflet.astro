---
import Layout from "../layouts/Layout.astro";
import "leaflet/dist/leaflet.css";
---

<Layout title="Carte des établissements">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js" is:inline></script>
  <script is:inline>
    const map = L.map('map').setView([46.8, 2.5], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    fetch('src/assets/etablissements.json')
      .then(r => r.json())
      .then(rows => {
        const features = rows
          .filter(r => r.coordonnees && r.coordonnees.lat && r.coordonnees.lon)
          .map(r => ({
            type: 'Feature',
            geometry: { type: 'Point', coordinates: [r.coordonnees.lon, r.coordonnees.lat] },
            properties: {
              nom: r.siege_lib || r.implantation_lib || r.sigle || r.uai,
              ville: r.com_nom,
              type: r.type_d_etablissement
            }
          }));

        const layer = L.geoJSON({ type: 'FeatureCollection', features }, {
          pointToLayer: (_, latlng) => L.circleMarker(latlng, { radius: 4 }),
          onEachFeature: (f, l) => {
            const p = f.properties;
            l.bindPopup(`<strong>${p.nom ?? 'Établissement'}</strong><br>${p.type ?? ''}<br>${p.ville ?? ''}`);
          }
        }).addTo(map);

        if (layer.getLayers().length) {
          map.fitBounds(layer.getBounds(), { padding: [20, 20] });
        }
      });
  </script>

  <style is:global>
    #map { height: 80vh; }
  </style>
</Layout>
